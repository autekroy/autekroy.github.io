<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="é˜¿æ‹‰æ–¯åŠ ">
    
    <!-- Icon Updated -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/6236/6236292.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/6236/6236292.png">
    <link rel="shortcut icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/6236/6236292.png">
    
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --theme-color: #2E86C1; /* Default Ice Blue */
            --text-primary: #1c1c1e;
            --text-secondary: #8e8e93;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --card-blur: rgba(255, 255, 255, 0.9); /* Slightly more opaque for contrast */
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
            --bg-base: #F2F2F7;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        /* --- iOS é–å®šç•«é¢èˆ‡å½ˆæ€§ä¿®æ­£ --- */
        html {
            height: 100%; width: 100%; overflow: hidden; 
            background-color: #f2f2f7; /* Light background default */
            overscroll-behavior: none;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Display", "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
            background-color: transparent; 
            color: var(--text-primary);
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            overflow: hidden; overscroll-behavior: none;
        }

        /* --- Animations --- */
        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .animate-item {
            opacity: 0;
            animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        .animate-item:nth-child(1) { animation-delay: 0.05s; }
        .animate-item:nth-child(2) { animation-delay: 0.1s; }
        .animate-item:nth-child(3) { animation-delay: 0.15s; }
        .animate-item:nth-child(4) { animation-delay: 0.2s; }
        .animate-item:nth-child(5) { animation-delay: 0.25s; }

        /* --- Backgrounds --- */
        .bg-container { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: -1; 
            pointer-events: none; background-color: #fff;
        }
        .bg-image {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover; background-position: center center;
            transition: opacity 0.6s ease; opacity: 0; transform: scale(1.02);
            z-index: 0;
        }
        .bg-image.active { opacity: 1; transform: scale(1); transition: opacity 0.6s ease, transform 10s linear; }
        .bg-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            /* Cleaner gradient: Transparent top -> White bottom */
            background: linear-gradient(to bottom, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.4) 30%, rgba(242,242,247,0.95) 85%);
            z-index: 1; 
            backdrop-filter: blur(0px); /* Removed blur to see image clearer */
        }

        /* --- Header --- */
        header {
            padding: calc(var(--safe-top) + 10px) 20px 10px;
            background: rgba(255, 255, 255, 0.85); /* Whiter header */
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 0.5px solid rgba(0,0,0,0.05);
            position: absolute; top: 0; left: 0; width: 100%; 
            z-index: 10; 
            display: flex; justify-content: space-between; align-items: flex-start;
            transition: all 0.3s;
        }
       
        .header-left h1 { font-size: 28px; font-weight: 800; margin: 0; letter-spacing: -0.5px; color: #000; }
        .header-left .subtitle { 
            font-size: 13px; color: var(--theme-color); font-weight: 700; 
            margin-top: 4px; text-transform: uppercase; letter-spacing: 1px; 
            transition: color 0.3s ease;
        }

        .weather-widget {
            text-align: right; background: rgba(255,255,255,0.8); padding: 6px 12px; border-radius: 14px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); display: flex; flex-direction: column; align-items: flex-end;
            border: 1px solid rgba(255,255,255,0.4);
            transition: opacity 0.3s ease, visibility 0.3s; cursor: pointer;
        }
        .weather-widget:active { transform: scale(0.95); background: rgba(255,255,255,0.8); }
        .weather-temp { font-size: 20px; font-weight: 700; color: #333; line-height: 1; }
        .weather-loc { font-size: 10px; color: #666; margin-top: 3px; font-weight: 600; text-transform: uppercase; }

        #countdown-banner {
            font-size: 11px; font-weight: 600; color: #fff; background: var(--theme-color);
            padding: 4px 10px; border-radius: 20px; margin-top: 5px; display: inline-block;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); opacity: 0; animation: fadeUp 0.5s 0.5s forwards;
            transition: background-color 0.3s ease;
        }

        /* --- Content --- */
        .content-area {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            overflow-y: auto; overflow-x: hidden;
            overscroll-behavior-y: none; -webkit-overflow-scrolling: touch;
            padding: calc(var(--safe-top) + 100px) 20px calc(var(--safe-bottom) + 90px);
            display: none; opacity: 0; transition: opacity 0.4s ease;
            z-index: 5;
        }
        .content-area.active { display: block; opacity: 1; }

        /* --- Weather Chart --- */
        .weather-detail-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            border-radius: 24px; padding: 20px 15px; margin-bottom: 20px;
            color: white; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3);
            position: relative; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer; transition: transform 0.2s;
        }
        .weather-detail-card:active { transform: scale(0.98); opacity: 0.9; }
        .wd-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 10px; padding: 0 5px; }
        .wd-title { font-weight: 700; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .wd-info { text-align: right; font-size: 12px; font-weight: 600; opacity: 0.9; }
       
        .wd-chart-container { width: 100%; height: 160px; position: relative; margin-top: 10px; }
        .wd-chart-svg { width: 100%; height: 100%; overflow: visible; display: block; }
        .chart-area { fill: rgba(255,255,255,0.15); }
        .chart-line { fill: none; stroke: white; stroke-width: 2.5; stroke-linecap: round; stroke-linejoin: round; filter: drop-shadow(0px 3px 3px rgba(0,0,0,0.1)); }
        .chart-dot { fill: white; stroke: rgba(0,0,0,0.1); stroke-width: 2px; }
        .chart-text { font-size: 11px; fill: white; font-weight: 700; text-anchor: middle; text-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .chart-label { font-size: 10px; fill: rgba(255,255,255,0.8); text-anchor: middle; font-weight: 500; }
       
        /* Chart Icons */
        #chart-icons-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .chart-icon-wrapper {
            position: absolute; transform: translateX(-50%); display: flex; justify-content: center; align-items: center;
        }
        .chart-icon-wrapper svg { width: 16px; height: 16px; color: rgba(255,255,255,0.9); filter: drop-shadow(0 2px 2px rgba(0,0,0,0.1)); }

        /* --- Aurora Chart --- */
        .aurora-detail-card {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); /* Aurora Green */
            border-radius: 24px; padding: 20px 15px; margin-bottom: 20px;
            color: white; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.3);
            position: relative; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.2);
            cursor: pointer; transition: transform 0.2s;
        }
        /* Overwrite gradient dynamically in JS */
        
        .bar-kp { fill: rgba(255, 255, 255, 0.9); transition: height 0.5s ease; }
        .line-cloud { fill: none; stroke: rgba(255,255,255,0.5); stroke-width: 2; stroke-dasharray: 4 2; }
        .dot-cloud { fill: rgba(255,255,255,0.5); }

        /* --- Scrollers --- */
        .day-scroller-container {
            position: sticky; top: 0; margin: -10px -20px 20px; padding: 15px 20px 10px;
            background: rgba(255,255,255,0.8); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            z-index: 5; border-bottom: 0.5px solid rgba(0,0,0,0.05);
            mask-image: linear-gradient(to bottom, black 85%, transparent 100%);
        }
        .day-scroller { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 10px; scrollbar-width: none; }
        .day-scroller::-webkit-scrollbar { display: none; }
       
        /* Day Chip */
        .day-chip {
            flex: 0 0 auto; display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-width: 68px; height: 64px; background: rgba(255,255,255,0.95); border-radius: 18px;
            font-size: 12px; color: var(--text-secondary); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            box-shadow: var(--shadow-sm); 
            border: 1.5px solid color-mix(in srgb, var(--theme-color), transparent 70%);
        }
        .day-chip span.d-date { font-size: 20px; font-weight: 800; color: #1c1c1e; margin-bottom: 2px; }
        .day-chip span.d-week { font-weight: 500; font-size: 11px; opacity: 0.8; }
        .day-chip.active {
            background: var(--theme-color); color: white; 
            box-shadow: 0 8px 20px -5px var(--theme-color); 
            transform: translateY(-2px) scale(1.05); border-color: transparent;
        }
        .day-chip.active span.d-date { color: white; }
       
        /* Guide Chip */
        .guide-chip {
            flex: 0 0 auto; padding: 0 20px; height: 44px; 
            display: flex; align-items: center; justify-content: center;
            background: rgba(255,255,255,0.9); border-radius: 22px;
            font-size: 14px; font-weight: 700; color: var(--text-secondary);
            box-shadow: var(--shadow-sm); 
            border: 1.5px solid color-mix(in srgb, var(--theme-color), transparent 70%); 
            transition: all 0.3s;
        }
        .guide-chip.active { 
            background: var(--theme-color); color: white; 
            box-shadow: 0 6px 15px -4px var(--theme-color); transform: translateY(-1px); border-color: transparent;
        }

        /* --- Map Button --- */
        .map-btn-compact {
            display: flex; align-items: center; justify-content: center; gap: 8px;
            width: 100%; padding: 14px; margin-bottom: 15px;
            background: rgba(255,255,255,0.8); border-radius: 18px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.5);
            color: var(--theme-color); font-weight: 700; font-size: 15px;
            text-decoration: none; box-shadow: var(--shadow-sm);
            transition: transform 0.2s, background 0.2s;
        }
        .map-btn-compact:active { transform: scale(0.98); background: rgba(255,255,255,0.9); }

        /* --- Card & Items --- */
        .card {
            background: var(--card-blur); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
            border-radius: 24px; padding: 0; margin-bottom: 16px;
            box-shadow: var(--shadow-md); overflow: hidden;
            border: 1px solid rgba(255,255,255,0.6);
        }

        /* First Card Spacing */
        #tab-hotels .card:first-child, 
        #tab-flights .card:first-child {
            margin-top: 24px;
        }

        .place-item {
            padding: 22px 20px; border-bottom: 1px solid rgba(0,0,0,0.05); position: relative;
            transition: background 0.2s; cursor: pointer;
        }
        .place-item:active { background: rgba(0,0,0,0.03); }
        .place-item:last-child { border-bottom: none; }
        .place-item::after {
            content: 'â€º'; position: absolute; right: 20px; top: 50%; transform: translateY(-50%);
            font-size: 22px; color: #c7c7cc; font-weight: 600;
        }
        .place-item.no-arrow::after { display: none; }

        .place-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-right: 20px; }
        .place-name { font-weight: 700; font-size: 18px; color: #1c1c1e; flex: 1; letter-spacing: -0.3px; }
       
        .place-tag { 
            font-size: 11px; background: var(--theme-color); padding: 5px 10px; border-radius: 10px; 
            color: white; font-weight: 700; white-space: nowrap; margin-left: 10px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .place-tag.secondary { background: #e5e5ea; color: #666; box-shadow: none; }
        .place-tag.highlight { background: #007AFF; color: white; box-shadow: 0 2px 6px rgba(0,122,255,0.3); }
        .place-tag.dark { background: #333; color: white; }
       
        .place-desc { font-size: 15px; color: #666; line-height: 1.5; margin: 0; padding-right: 15px; }
        .hotel-date { font-size: 13px; color: #8e8e93; margin-top: 6px; display: block; font-weight: 600; }

        /* --- Packing List Styles --- */
        .packing-header {
            padding: 20px 20px 10px;
        }
        .progress-container {
            width: 100%; height: 8px; background: #e5e5ea; border-radius: 4px; overflow: hidden; margin-top: 10px;
        }
        .progress-bar {
            height: 100%; background: #34C759; width: 0%; transition: width 0.3s ease;
        }
        .progress-text {
            font-size: 13px; color: #8e8e93; font-weight: 600; margin-top: 8px; display: flex; justify-content: space-between;
        }
       
        .checkbox-item {
            display: flex; align-items: center; padding: 16px 20px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: background 0.2s;
        }
        .checkbox-item:last-child { border-bottom: none; }
        .checkbox-item:active { background: rgba(0,0,0,0.02); }
       
        .custom-checkbox {
            width: 24px; height: 24px; border-radius: 6px; border: 2px solid #c7c7cc; margin-right: 15px;
            display: flex; align-items: center; justify-content: center; transition: all 0.2s;
        }
        .checkbox-item.checked .custom-checkbox {
            background: #34C759; border-color: #34C759;
        }
        .checkbox-item.checked .place-name {
            color: #aeaeb2; text-decoration: line-through;
        }
        .check-icon { color: white; opacity: 0; transform: scale(0.5); transition: all 0.2s; }
        .checkbox-item.checked .check-icon { opacity: 1; transform: scale(1); }

        /* --- Flight & Shuttle --- */
        .flight-time-row {
            display: flex; justify-content: space-between; align-items: center;
            margin: 18px 0; padding: 12px 0; border-top: 1px dashed rgba(0,0,0,0.1); border-bottom: 1px dashed rgba(0,0,0,0.1);
        }
        .flight-time-col { text-align: center; flex: 1; }
        .ft-label { font-size: 11px; color: #8e8e93; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; font-weight: 600; }
        .ft-time { font-size: 22px; font-weight: 800; color: #1c1c1e; font-variant-numeric: tabular-nums; }
        .ft-icon { color: #d1d1d6; margin: 0 10px; }
       
        .lounge-info {
            background: #f2f2f7; padding: 14px; border-radius: 16px; margin-top: 12px; display: flex; gap: 12px; align-items: flex-start;
        }
        .lounge-text { font-size: 13px; color: #444; line-height: 1.5; font-weight: 500; }
        .lounge-badge { background: #002663; color: white; font-size: 10px; padding: 3px 8px; border-radius: 6px; font-weight: 800; display: inline-block; margin-bottom: 4px; }
       
        .shuttle-block { padding: 24px; background: transparent; }
        .shuttle-title { display: flex; align-items: center; gap: 8px; font-weight: 700; color: var(--theme-color); margin-bottom: 16px; font-size: 16px; }
        .shuttle-container { background: rgba(255,255,255,0.6); border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid rgba(255,255,255,0.5); }

        /* --- Modal --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3);
            z-index: 200; opacity: 0; visibility: hidden; transition: all 0.3s;
            backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px);
        }
        .modal-overlay.open { opacity: 1; visibility: visible; }
        .modal-sheet {
            position: absolute; bottom: 0; left: 0; width: 100%; background: #fff;
            border-radius: 30px 30px 0 0; padding: 30px 25px 60px;
            transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            max-height: 85vh; overflow-y: auto;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.1);
        }
        .modal-overlay.open .modal-sheet { transform: translateY(0); }
        .modal-handle { width: 40px; height: 5px; background: #e5e5ea; border-radius: 10px; margin: -10px auto 30px; }
        .modal-title { font-size: 26px; font-weight: 800; margin-bottom: 15px; color: #000; line-height: 1.2; }
        .modal-desc { font-size: 17px; color: #3a3a3c; line-height: 1.6; white-space: pre-wrap; font-weight: 400; }
        .modal-close-btn {
            position: absolute; top: 25px; right: 25px; background: #f2f2f7; border: none; 
            width: 32px; height: 32px; border-radius: 50%; font-size: 20px; 
            color: #3c3c43; display: flex; align-items: center; justify-content: center;
            cursor: pointer;
        }

        /* --- Tab Bar (Fixed & Compact) --- */
        .tab-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(255,255,255,0.98); 
            backdrop-filter: blur(30px) saturate(180%);
            -webkit-backdrop-filter: blur(30px) saturate(180%);
            border-top: 0.5px solid rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-around;
            padding-top: 8px; 
            padding-bottom: calc(2px + env(safe-area-inset-bottom)); 
            z-index: 100; /* FIXED: Tab bar on top */
        }
       
        .tab-item {
            flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: #999; font-size: 10px; gap: 3px; cursor: pointer; transition: all 0.2s;
        }
        .tab-item.active { color: var(--theme-color); transform: translateY(-2px); }
        .tab-item.active svg { stroke-width: 2.5px; }

        .btn-action {
            display: inline-flex; align-items: center; gap: 8px; background: #f2f2f7; color: var(--theme-color); 
            padding: 10px 20px; border-radius: 14px; font-size: 15px; font-weight: 600; text-decoration: none; margin-top: 15px;
            transition: transform 0.2s;
        }
        .btn-action:active { transform: scale(0.96); opacity: 0.8; }
    </style>
</head>
<body>

    <div class="bg-container">
        <div id="bg-itinerary" class="bg-image active"></div>
        <div id="bg-flights" class="bg-image" style="background-image: url('https://images.unsplash.com/photo-1542296332-2e44a9917ad2?q=80&w=1080');"></div>
        <div id="bg-hotels" class="bg-image" style="background-image: url('https://images.unsplash.com/photo-1566073771259-6a8506099945?q=80&w=1080');"></div>
        <div id="bg-guide" class="bg-image" style="background-image: url('https://images.unsplash.com/photo-1524661135-423995f22d0b?q=80&w=1080');"></div>
        <div class="bg-overlay"></div>
    </div>

    <header>
        <div class="header-left">
            <h1 id="header-title">âœ¨ é˜¿æ‹‰æ–¯åŠ æ¥µå…‰è¡Œ âœ¨</h1>
            <div class="subtitle" id="header-subtitle">Overview</div>
            <div id="countdown-banner">å³å°‡å‡ºç™¼ âœˆï¸</div>
        </div>
        <div class="weather-widget" id="header-weather-widget" onclick="openCurrentWeather()">
            <span class="weather-temp" id="current-temp">--Â°</span>
            <span class="weather-loc" id="current-loc">LOADING</span>
        </div>
    </header>

    <!-- TAB 1: ITINERARY -->
    <div id="tab-itinerary" class="content-area active">
        <div class="day-scroller-container"><div class="day-scroller"></div></div>
        <div id="day-content"></div>
    </div>

    <!-- TAB 2: FLIGHTS -->
    <div id="tab-flights" class="content-area">
        <!-- Flight cards here (unchanged) -->
        <div class="card animate-item">
            <div class="place-item no-arrow">
                <div class="place-header">
                    <span class="place-name">å»ç¨‹: SJC â ANC</span>
                    <span class="place-tag secondary">12/26</span>
                </div>
                <div style="margin-top:10px; border-left: 2px solid #ddd; padding-left: 10px;">
                    <p class="place-desc"><strong>AS 762</strong>: SJC â SEA</p>
                    <a href="https://www.google.com/search?q=Alaska+Airlines+762+status+2025-12-26" target="_blank" class="btn-action" style="font-size:12px; padding: 5px 10px; margin-top:5px;"><i data-lucide="plane-takeoff"></i> è¿½è¹¤ AS762</a>
                </div>
                <div style="margin: 10px 0; color:#8e8e93; font-size:12px; padding-left: 12px;">
                    <i data-lucide="clock" size="12"></i> è¥¿é›…åœ– (SEA) è½‰æ©Ÿ
                </div>
                <div style="margin-bottom:10px; border-left: 2px solid #2E86C1; padding-left: 10px;">
                    <p class="place-desc"><strong>AS 129</strong>: SEA â ANC</p>
                     <a href="https://www.google.com/search?q=Alaska+Airlines+129+status+2025-12-26" target="_blank" class="btn-action" style="font-size:12px; padding: 5px 10px; margin-top:5px;"><i data-lucide="plane-takeoff"></i> è¿½è¹¤ AS129</a>
                </div>
                <div class="lounge-info">
                     <div class="lounge-text">é è¨ˆæŠµé”å®‰å…‹æ‹‰æ²»æ™‚é–“ä¾ç•¶æ—¥èˆªç­ç‚ºæº–ã€‚</div>
                </div>
            </div>
        </div>
        <div class="card animate-item">
            <div class="place-item no-arrow">
                <div class="place-header">
                    <span class="place-name">ç§»å‹•: ANC â FAI</span>
                    <span class="place-tag secondary">12/28</span>
                </div>
                 <p class="place-desc"><strong>AS 108</strong>: Anchorage to Fairbanks</p>
                 <div class="flight-time-row">
                    <div class="flight-time-col"><div class="ft-label">èµ·é£›</div><div class="ft-time">10:20</div></div>
                    <i data-lucide="arrow-right" size="16" class="ft-icon"></i>
                    <div class="flight-time-col"><div class="ft-label">æŠµé”</div><div class="ft-time">11:30</div></div>
                </div>
                 <a href="https://www.google.com/search?q=Alaska+Airlines+108+status+2025-12-28" target="_blank" class="btn-action" style="width:100%; justify-content:center;"><i data-lucide="radar"></i> AS108 å³æ™‚å‹•æ…‹</a>
            </div>
        </div>
        <div class="card animate-item">
            <div class="place-item no-arrow">
                <div class="place-header">
                    <span class="place-name">å›ç¨‹: FAI â SJC</span>
                    <span class="place-tag secondary">12/31</span>
                </div>
                <div style="margin-top:10px; border-left: 2px solid #ddd; padding-left: 10px;">
                    <p class="place-desc"><strong>AS 106</strong>: FAI â SEA</p>
                    <a href="https://www.google.com/search?q=Alaska+Airlines+106+status+2025-12-31" target="_blank" class="btn-action" style="font-size:12px; padding: 5px 10px; margin-top:5px;"><i data-lucide="plane-takeoff"></i> è¿½è¹¤ AS106</a>
                </div>
                <div style="margin: 10px 0; color:#8e8e93; font-size:12px; padding-left: 12px;">
                    <i data-lucide="clock" size="12"></i> è¥¿é›…åœ– (SEA) è½‰æ©Ÿ
                </div>
                <div style="margin-bottom:10px; border-left: 2px solid #2E86C1; padding-left: 10px;">
                    <p class="place-desc"><strong>AS 761</strong>: SEA â SJC</p>
                     <a href="https://www.google.com/search?q=Alaska+Airlines+761+status+2025-12-31" target="_blank" class="btn-action" style="font-size:12px; padding: 5px 10px; margin-top:5px;"><i data-lucide="plane-takeoff"></i> è¿½è¹¤ AS761</a>
                </div>
            </div>
        </div>
         <div class="card animate-item">
                 <div class="place-item no-arrow">
                    <div class="place-header"><span class="place-name">Fairbanks ç§Ÿè»Š</span><span class="place-tag secondary">Enterprise</span></div>
                    <p class="place-desc" style="margin-top:5px;"><strong>å–è»Šï¼š</strong> 12/29 12:00 PM @ FAI Airport<br><strong>é‚„è»Šï¼š</strong> 12/31 12:00 PM @ FAI Airport</p>
                    <div class="lounge-info" style="margin-top:8px;">
                        <div class="lounge-text">âš ï¸ å‹™å¿…æª¢æŸ¥ Engine Block Heater ç·šæã€‚</div>
                   </div>
                </div>
            </div>
    </div>

    <!-- TAB 3: HOTELS -->
    <div id="tab-hotels" class="content-area">
        <div class="card animate-item">
            <div class="place-item" onclick="openModal('Hyatt Place Anchorage', 'Midtown èˆ’é©ä½å®¿', '12/26 ä¸‹åˆå…¥ä½ã€‚\\nä½æ–¼ Midtown æ ¸å¿ƒå€åŸŸï¼Œè·é›¢æ©Ÿå ´èˆ‡å¸‚å€éƒ½å¾ˆè¿‘ã€‚æä¾›å…è²»æ—©é¤ã€‚')">
                <div class="place-header"><span class="place-name">Hyatt Place Midtown</span><span class="place-tag highlight" style="background:#2E86C1">2 æ™š</span></div>
                <span class="hotel-date">12/26 - 12/28</span>
                <p class="place-desc">ğŸ“ Anchorage, AK</p>
                <a href="https://www.google.com/maps/search/?api=1&query=Hyatt+Place+Anchorage+Midtown" target="_blank" class="btn-action" style="background:#eaf2f8; color:#2E86C1" onclick="event.stopPropagation()"><i data-lucide="map-pin"></i> å°èˆª</a>
            </div>
        </div>
        <div class="card animate-item">
            <div class="place-item" onclick="openModal('Pike\'s Waterfront Lodge', 'æ²³ç•”æœ¨å±‹åº¦å‡æ‘', '12/28 ä¸­åˆæŠµé”å¾Œå…¥ä½ã€‚\\nä½æ–¼ Chena River æ²³ç•”ï¼Œæœ‰è‘—åçš„ Pikes Landing é¤å»³ã€‚\\nâš ï¸ é‡è¦ï¼šæŠµé”æ©Ÿå ´å¾Œï¼Œè«‹æ‰“é›»è©±è©¢å• Free Shuttle æ¥é§è»Šç­æ¬¡ã€‚')">
                <div class="place-header"><span class="place-name">Pike's Waterfront Lodge</span><span class="place-tag highlight" style="background:#27AE60">3 æ™š</span></div>
                <span class="hotel-date">12/28 - 12/31</span>
                <p class="place-desc">ğŸ“ Fairbanks, AK</p>
                <a href="https://www.google.com/maps/search/?api=1&query=Pike's+Waterfront+Lodge" target="_blank" class="btn-action" style="background:#eafaf1; color:#27AE60" onclick="event.stopPropagation()"><i data-lucide="map-pin"></i> å°èˆª</a>
            </div>
        </div>
    </div>

    <!-- TAB 4: GUIDE (Includes Prep) -->
    <div id="tab-guide" class="content-area">
        <div class="day-scroller-container"><div class="day-scroller" id="guide-scroller"></div></div>
        <div id="guide-content"></div>
    </div>

    <!-- MODAL -->
    <div class="modal-overlay" id="detail-modal" onclick="closeModal()">
        <div class="modal-sheet" onclick="event.stopPropagation()">
            <div class="modal-handle"></div>
            <button class="modal-close-btn" onclick="closeModal()">Ã—</button>
            <div class="modal-title" id="modal-title">Title</div>
            <div class="modal-desc" id="modal-desc">Description</div>
        </div>
    </div>

    <!-- TAB BAR -->
    <nav class="tab-bar">
        <div class="tab-item active" onclick="switchTab('itinerary', this)"><i data-lucide="map" size="24"></i><span>è¡Œç¨‹</span></div>
        <div class="tab-item" onclick="switchTab('flights', this)"><i data-lucide="plane" size="24"></i><span>äº¤é€š</span></div>
        <div class="tab-item" onclick="switchTab('hotels', this)"><i data-lucide="bed" size="24"></i><span>ä½å®¿</span></div>
        <div class="tab-item" onclick="switchTab('guide', this)"><i data-lucide="book-open" size="24"></i><span>æŒ‡å—</span></div>
    </nav>

    <script>
        lucide.createIcons();
        let currentHourlyTemps = [];
        let currentWeatherLoc = ""; // Store current location for click handler
        let currentHourlyCodes = []; // Store weather codes
        let currentAuroraCloud = []; // Store cloud cover for aurora

        // --- DATA ---
        const daysData = [
            { date: "12/26", fullDate: "2025-12-26", week: "é€±äº”", title: "æŠµé”å®‰å…‹æ‹‰æ²»", color: "#2E86C1", bgImg: "https://images.unsplash.com/photo-1483921020237-2ff51e8e4b22?q=80&w=1080", gradient: "linear-gradient(135deg, #1A2980 0%, #26D0CE 100%)", weatherLoc: "Anchorage, AK", coords: "61.2181,-149.9003", mapUrl: "https://www.google.com/maps/search/Anchorage+Airport", content: [
                { name: "ğŸ›¬ æŠµé” & é›†åˆ", desc: "æˆ‘: 1:30 PM | å§œ: 2:00+ PM", tag: "æ©Ÿå ´", info: "é›†åˆå¾Œå« Uber å‰å¾€é£¯åº— Check-inã€‚" },
                { name: "ğŸ¿ å–é›ªå…·", desc: "å‰å¾€ç§Ÿè³ƒåº—å–è£å‚™ã€‚", tag: "é‡è¦", info: "è©¦ç©¿é›ªé´å¤§å°ï¼Œç¢ºèªä¿æš–åº¦ã€‚" },
                { name: "ğŸ›ï¸ æ¡è²· & é€›è¡—", desc: "Outlet & è¶…å¸‚è£œçµ¦ã€‚", tag: "è£œçµ¦", info: "è³¼è²·å†°å·å¾’æ­¥èˆ‡åŒ—æ¥µåœˆä¹‹æ—…éœ€è¦çš„é£Ÿç‰©ï¼ˆä¸‰æ˜æ²»ã€èƒ½é‡æ£’ã€æ°´ï¼‰ã€‚" }
            ]},
            { date: "12/27", fullDate: "2025-12-27", week: "é€±å…­", title: "é¦¬å¡”åŠªæ–¯å¡å†°å·", color: "#00BCD4", bgImg: "https://images.unsplash.com/photo-1500375592092-40eb2168fd21?q=80&w=1080", gradient: "linear-gradient(135deg, #2193b0 0%, #6dd5ed 100%)", weatherLoc: "Sutton, AK", coords: "61.7114,-148.8872", mapUrl: "https://www.google.com/maps/search/Matanuska+Glacier", content: [
                { name: "ğŸšŒ é›†åˆå‡ºç™¼", desc: "æº–å‚™å‰å¾€å†°å·ã€‚", tag: "7:50 AM", info: "ç©¿è‘—ä¿æš–ï¼Œå¸¶å¥½ç›¸æ©Ÿèˆ‡ä¹¾ç³§ã€‚" },
                { name: "ğŸ§Š å†°å·å¾’æ­¥", desc: "Matanuska Glacier Hikeã€‚", tag: "å…¨å¤©", info: "è·Ÿéš¨åš®å°ï¼Œæ³¨æ„å†°è£‚ç¸«ï¼Œç©¿å¥½å†°çˆªã€‚" },
                { name: "ğŸ½ï¸ è¿”å›å¸‚å€", desc: "æ™šé¤ & ä¼‘æ¯ã€‚", tag: "5:00 PM", info: "è¿”å›å®‰å…‹æ‹‰æ²»å¸‚å€ï¼Œæ‰¾å®¶æº«æš–çš„é¤å»³åƒæ™šé¤ã€‚" }
            ]},
            { date: "12/28", fullDate: "2025-12-28", week: "é€±æ—¥", title: "é£›å¾€è²»çˆ¾ç­å…‹æ–¯", color: "#8E44AD", bgImg: "https://images.unsplash.com/photo-1476514525535-07fb3b4ae5f1?q=80&w=1080", gradient: "linear-gradient(135deg, #cc2b5e 0%, #753a88 100%)", weatherLoc: "Fairbanks, AK", coords: "64.8378,-147.7164", mapUrl: "https://www.google.com/maps/dir/Anchorage/Fairbanks", content: [
                { name: "ğŸ¨ Check-out", desc: "å‰å¾€æ©Ÿå ´ã€‚", tag: "8:20 AM", info: "é ç•™æ™‚é–“éå®‰æª¢ã€‚" },
                { name: "âœˆï¸ é£›å¾€ Fairbanks", desc: "AS 108: 10:20 Dep - 11:30 Arrã€‚", tag: "é£›è¡Œ", info: "æŠµé”å¾Œå«è»Šå»é£¯åº— Check-inã€‚*æ‰“é›»è©±å• Free Shuttle é »ç‡ã€‚" },
                { name: "â„ï¸ åŒ—æ¥µåœˆä¹‹æ—…", desc: "é›†åˆå‡ºç™¼ï¼", tag: "12:30 PM", info: "æ¼«é•·çš„è»Šç¨‹ï¼Œæº–å‚™å¥½é ¸æ•å’Œé›¶é£Ÿã€‚é è¨ˆéš”å¤©å‡Œæ™¨ 3:00 è¿”å›ã€‚" }
            ]},
            { date: "12/29", fullDate: "2025-12-29", week: "é€±ä¸€", title: "è²»çˆ¾ç­å…‹æ–¯", color: "#34495E", bgImg: "https://images.unsplash.com/photo-1518182170546-0766aaef3194?q=80&w=1080", gradient: "linear-gradient(135deg, #2c3e50 0%, #4ca1af 100%)", weatherLoc: "Fairbanks, AK", coords: "64.8378,-147.7164", mapUrl: "https://www.google.com/maps/search/Museum+of+the+North", content: [
                { name: "ğŸš— å–è»Š", desc: "Enterprise @ FAIã€‚", tag: "12:00 PM", info: "æª¢æŸ¥ Engine Block Heater ç·šæã€‚" },
                { name: "ğŸ›ï¸ å¸‚å€è§€å…‰", desc: "é…’å»  æˆ– åŒ—æ–¹æ¥µåœ°åšç‰©é¤¨ã€‚", tag: "ä¸‹åˆ", info: "Museum of the North å€¼å¾—ä¸€å»ï¼Œäº†è§£æ¥µåœ°ç”Ÿæ…‹ã€‚" },
                { name: "ğŸ‘€ æ¢è·¯", desc: "Murphy Domeã€‚", tag: "è·¯æ³", info: "è¶å¤©äº®ç¢ºèªå‰å¾€ Murphy Dome çš„è·¯æ³ï¼Œè©•ä¼°æ™šä¸Šæ˜¯å¦é©åˆè‡ªè¡Œå‰å¾€è¿½å…‰ã€‚" }
            ]},
            { date: "12/30", fullDate: "2025-12-30", week: "é€±äºŒ", title: "ç‹—æ‹‰é›ªæ©‡ & æ¥µå…‰", color: "#27AE60", bgImg: "https://images.unsplash.com/photo-1579033461380-adb47c3eb938?q=80&w=1080", gradient: "linear-gradient(135deg, #11998e 0%, #38ef7d 100%)", weatherLoc: "Fairbanks, AK", coords: "64.8378,-147.7164", mapUrl: "https://www.google.com/maps/search/Fairbanks+Dog+Sledding", content: [
                { name: "ğŸ• ç‹—æ‹‰é›ªæ©‡", desc: "10:00 å‡ºé–€ï¼Œ11:00 æŠµé”ã€‚", tag: "11:00 AM", info: "èˆ‡é›ªæ©‡çŠ¬äº’å‹•ï¼Œæ³¨æ„ä¿æš–ï¼ˆé¢¨å¾ˆå¤§ï¼‰ã€‚" },
                { name: "ğŸ§Š å†°é›•å±•", desc: "åƒè§€ Ice Artã€‚", tag: "ä¸‹åˆ", info: "æ¬£è³ä¸–ç•Œç´šçš„å†°é›•ä½œå“ã€‚" },
                { name: "ğŸŒŒ æ¥µå…‰åœ˜", desc: "è¿½é€æ­è‹¥æ‹‰ã€‚", tag: "8:00 PM", info: "è·Ÿéš¨å°éŠå‰å¾€ç„¡å…‰å®³åœ°å€ç­‰å¾…æ¥µå…‰çˆ†ç™¼ã€‚" }
            ]},
            { date: "12/31", fullDate: "2025-12-31", week: "é€±ä¸‰", title: "è¿”ç¨‹", color: "#95A5A6", bgImg: "https://images.unsplash.com/photo-1436491865332-7a61a109cc05?q=80&w=1080", gradient: "linear-gradient(120deg, #bdc3c7 0%, #2c3e50 100%)", weatherLoc: "Fairbanks Airport", coords: "64.8151,-147.8564", mapUrl: "https://www.google.com/maps", content: [
                { name: "ğŸ¿ é‚„é›ªå…·", desc: "æ­¸é‚„ç§Ÿè³ƒè£å‚™ã€‚", tag: "10:00 AM", info: "æª¢æŸ¥è£å‚™æ˜¯å¦é½Šå…¨ç„¡æå£ã€‚" },
                { name: "ğŸš— é‚„è»Š", desc: "Enterprise @ FAIã€‚", tag: "12:00 PM", info: "åŠ æ»¿æ²¹ï¼Œæ¸…ç†è»Šå…§åƒåœ¾ã€‚" },
                { name: "âœˆï¸ é£›å¾€ SJC", desc: "AS 106 / AS 761ã€‚", tag: "è¿”å®¶", info: "ç¶“è¥¿é›…åœ–è½‰æ©Ÿè¿”å› San Joseã€‚" }
            ]}
        ];

        const guideData = [
            { category: "ğŸ’ æº–å‚™", id: "prep", content: [] },
            { category: "ğŸš— äº¤é€šæŒ‡å—", content: [
                { name: "Engine Block Heater", tag: "å¿…è®€", desc: "åœè»Šä¸€å®šè¦æ’é›»ï¼", info: "ğŸ’¬ **ç‚ºä»€éº¼ï¼Ÿ**\nFairbanks å†¬å¤©æ¥µå†·ï¼Œåœè»Šè¶…é 2-3 å°æ™‚æœªç™¼å‹•ï¼Œå¼•æ“æ²¹è·¯å¯èƒ½å‡çµã€‚\n\nğŸ”Œ **æ€éº¼åšï¼Ÿ**\nè»Šé ­é€šå¸¸æœ‰ä¸€æ¢æ’é ­éœ²å‡ºä¾†ï¼Œåœè»Šä½å‰æ–¹æœƒæœ‰æ’åº§ã€‚åœå¥½è»Šå¾Œï¼Œå‹™å¿…å°‡æ’é ­æ’ä¸Šã€‚èµ·æ­¥å‰è¨˜å¾—æ‹”æ‰ï¼" },
                { name: "é›ªåœ°é§•é§›", tag: "å®‰å…¨", desc: "æ…¢æ…¢æ…¢ï¼Œä¸è¦æ€¥ç…ã€‚", info: "ğŸ’¬ **æŠ€å·§ï¼š**\n1. ç…è»Šè·é›¢æ˜¯å¹³å¸¸çš„ 3 å€ï¼Œè«‹ä¿æŒè¶…é•·è»Šè·ã€‚\n2. è‹¥é‡æ‰“æ»‘ï¼Œä¸è¦é‡è¸©ç…è»Šï¼Œè¼•æ”¾æ²¹é–€ä¸¦å°‡æ–¹å‘ç›¤æ‰“å‘æ‰“æ»‘æ–¹å‘ã€‚\n3. è»Šä¸Šéš¨æ™‚æº–å‚™é›ªåˆ· (Snow Brush)ã€‚" },
                { name: "é›¢ç·šåœ°åœ–", tag: "APP", desc: "Google Maps é›¢ç·šä¸‹è¼‰ã€‚", info: "ğŸ’¬ **å€åŸŸï¼š**\nè«‹ä¸‹è¼‰ Anchorage åˆ° Fairbanks æ²¿ç·šï¼Œä»¥åŠ Fairbanks å‘¨é‚Šï¼ˆåŒ…å« Chena Hot Springs è·¯æ®µï¼‰ã€‚å¾ˆå¤šåœ°æ–¹æ²’æœ‰è¨Šè™Ÿã€‚" }
            ]},
            { category: "ğŸŒ… æ—¥ç…§èˆ‡å¤©æ°£", content: [
                { name: "æ—¥ç…§æ™‚é–“", tag: "æ¥µçŸ­", desc: "æ—©ä¸Š10é»äº®ï¼Œä¸‹åˆ3é»é»‘ã€‚", info: "ğŸ’¬ **è¦åŠƒå»ºè­°ï¼š**\nå› ç‚ºæ—¥ç…§æ™‚é–“éå¸¸çŸ­ï¼Œæˆ¶å¤–æ™¯é»ï¼ˆå¦‚å†°é›•ã€åšç‰©é¤¨å¤–è§€ã€æ‹ç…§ï¼‰è«‹å‹™å¿…å®‰æ’åœ¨ 11:00 AM - 2:00 PM ä¹‹é–“ã€‚ä¸‹åˆ 3 é»å¾Œå¤©é»‘é©åˆå®¤å…§æ´»å‹•æˆ–ä¼‘æ¯ç­‰å¾…æ¥µå…‰ã€‚" },
                { name: "æ¥µå…‰é æ¸¬", tag: "APP", desc: "Aurora Forecastã€‚", info: "ğŸ’¬ **æ¨è–¦ APPï¼š**\n1. My Aurora Forecast\n2. UAF Geophysical Institute (ç¶²ç«™)\nKP å€¼å¤§æ–¼ 3 å°±å¾ˆæœ‰æ©Ÿæœƒçœ‹åˆ°ã€‚" },
                { name: "ä¿æš–ç­–ç•¥", tag: "ç©¿æ­", desc: "æ´‹è”¥å¼ç©¿æ³•ï¼Œæœ€å¤–å±¤é˜²é¢¨ã€‚", info: "ğŸ’¬ **é‡é»ï¼š**\næ‰‹è…³æœ€å®¹æ˜“å‡å‚·ã€‚è«‹æº–å‚™æš–æš–åŒ…è²¼åœ¨è…³åº•ï¼Œæˆ´å…©å±¤æ‰‹å¥—ï¼ˆå…§å±¤è–„ã€å¤–å±¤åšé˜²æ°´ï¼‰ã€‚" }
            ]},
            { category: "ğŸ» èªè­˜é˜¿æ‹‰æ–¯åŠ ", content: [
                { name: "The Last Frontier", tag: "ç°¡ä»‹", desc: "æœ€å¾Œçš„é‚Šç–†ã€‚", info: "ğŸ’¬ **å¤§å¾—é©šäººï¼š**\né˜¿æ‹‰æ–¯åŠ æ˜¯ç¾åœ‹æœ€å¤§çš„å·ï¼ˆæ˜¯å¾·å·çš„å…©å€å¤§ï¼ï¼‰ï¼Œä½†äººå£å¯†åº¦æ¥µä½ã€‚é€™è£¡æœ‰ç¾åœ‹æœ€é«˜çš„å±±å³°ï¼ˆDenaliï¼‰å’Œæ•¸ä¸æ¸…çš„å†°å·ã€‚\n\nğŸ§Š **æ°£å€™ï¼š**\nå…§é™¸ï¼ˆå¦‚ Fairbanksï¼‰æ˜¯å¤§é™¸æ€§æ°£å€™ï¼Œå†¬å¤©æ¥µå†·ä¸”ä¹¾ç‡¥ï¼›æ²¿æµ·ï¼ˆå¦‚ Anchorageï¼‰å—æµ·æ´‹èª¿ç¯€ï¼Œç›¸å°ã€Œæº«æš–ã€æ¿•æ½¤ã€‚" },
                { name: "é‡è¦‹ Moose (éº‹é¹¿)", tag: "å®‰å…¨", desc: "æ¯”ç†Šé‚„å¸¸è¦‹ï¼Œä¹Ÿæ›´å±éšªã€‚", info: "ğŸ’¬ **å¸‚å€éœ¸ä¸»ï¼š**\nåœ¨ Anchorage å’Œ Fairbanks å¸‚å€çœ‹åˆ°éº‹é¹¿é€›å¤§è¡—æ˜¯éå¸¸æ­£å¸¸çš„ã€‚ç‰ å€‘é«”å‹å·¨å¤§ï¼Œå†¬å¤©è„¾æ°£ä¸å¥½ã€‚\n\nâš ï¸ **æ‡‰å°ï¼š**\nçµ•å°ä¸è¦é è¿‘ï¼å¦‚æœçœ‹åˆ°ç‰ è€³æœµå‘å¾Œè²¼å¹³ï¼Œä»£è¡¨ç‰ åœ¨ç”Ÿæ°£ã€‚è«‹èº²åœ¨æ¨¹æˆ–è»Šå­å¾Œé¢ï¼Œä¸è¦å¥”è·‘ã€‚" },
                { name: "åŸä½æ°‘æ–‡åŒ–", tag: "äººæ–‡", desc: "è±å¯Œçš„æ­·å²åº•è˜Šã€‚", info: "ğŸ’¬ **å¤šå…ƒæ—ç¾¤ï¼š**\né˜¿æ‹‰æ–¯åŠ æœ‰è¨±å¤šåŸä½æ°‘æ—ç¾¤ï¼Œå¦‚ Inupiat, Yup'ik, Athabascan ç­‰ã€‚ä½ å¯ä»¥å» Fairbanks çš„ Museum of the North æ·±å…¥äº†è§£ä»–å€‘çš„ç‹—æ‹‰é›ªæ©‡æ­·å²å’Œæ¥µåœ°ç”Ÿå­˜æ™ºæ…§ã€‚" }
            ]},
            { category: "ğŸŒŒ æ¥µå…‰æ”»ç•¥", content: [
                { name: "ğŸ”´ å³æ™‚æ¥µå…‰/é›²åœ–æŸ¥è©¢", tag: "Live", desc: "é»æ“ŠæŸ¥çœ‹ KP å€¼èˆ‡é å ±ç¶²ç«™ã€‚", info: "è¿½æ¥µå…‰æœ€é‡è¦çš„å°±æ˜¯ **KPå€¼** (å¤ ä¸å¤ å¼·) å’Œ **å¤©æ°£** (æœ‰æ²’æœ‰é›²)ã€‚\n\næ¨è–¦ä½¿ç”¨ä»¥ä¸‹æ¬Šå¨ç¶²ç«™æŸ¥è©¢ï¼š\n\n1. **UAF Geophysical Institute**\né˜¿æ‹‰æ–¯åŠ å¤§å­¸å®˜æ–¹é å ±ï¼Œæœ€æº–ç¢ºçš„åœ¨åœ°è³‡æ–™ã€‚\n\n2. **NOAA Space Weather**\nç¾åœ‹åœ‹å®¶æµ·æ´‹æš¨å¤§æ°£ç¸½ç½²ï¼Œæä¾› 30 åˆ†é˜å…§çš„çŸ­æœŸé æ¸¬ã€‚\n\nğŸ‘‡ **é»æ“Šä¸‹æ–¹æŒ‰éˆ•å‰å¾€ï¼š**<br><br><a href='https://www.gi.alaska.edu/monitors/aurora-forecast' target='_blank' style='display:block; padding:12px; background:#2980b9; color:white; text-align:center; border-radius:8px; text-decoration:none; margin-bottom:10px; font-weight:bold;'>ğŸš€ UAF æ¥µå…‰é å ± (ç¶²ç«™)</a><a href='https://www.swpc.noaa.gov/products/aurora-30-minute-forecast' target='_blank' style='display:block; padding:12px; background:#27ae60; color:white; text-align:center; border-radius:8px; text-decoration:none; font-weight:bold;'>ğŸŒ NOAA 30åˆ†é˜åˆ†ä½ˆåœ–</a><a href='https://www.weather.gov/afg/' target='_blank' style='display:block; padding:12px; background:#8e44ad; color:white; text-align:center; border-radius:8px; text-decoration:none; margin-top:10px; font-weight:bold;'>â˜ï¸ Fairbanks å®˜æ–¹å¤©æ°£ (é›²é‡)</a>" },
                { name: "æ¥µå…‰æ˜¯ä»€éº¼ï¼Ÿ", tag: "ç§‘æ™®", desc: "å¤ªé™½é¢¨èˆ‡å¤§æ°£å±¤çš„ç†±èˆã€‚", info: "ğŸ’¬ **åŸç†ï¼š**\nå¤ªé™½é‡‹æ”¾çš„å¸¶é›»ç²’å­ï¼ˆå¤ªé™½é¢¨ï¼‰æ’æ“Šåœ°çƒç£å ´ï¼Œè¢«å¼•å°åˆ°å—åŒ—æ¥µï¼Œèˆ‡å¤§æ°£å±¤ä¸­çš„æ°£é«”ç¢°æ’ç™¼å…‰ã€‚\n\nğŸŸ¢ **ç¶ è‰²ï¼š** æœ€å¸¸è¦‹ï¼Œæ°§åŸå­åœ¨è¼ƒä½é«˜åº¦ç¢°æ’ã€‚\nğŸ”´ **ç´…è‰²ï¼š** è¼ƒç½•è¦‹ï¼Œæ¥µå¼·çƒˆå¤ªé™½é¢¨æš´æ™‚ï¼Œæ°§åŸå­åœ¨é«˜ç©ºç¢°æ’ã€‚" },
                { name: "KP å€¼è§£è®€", tag: "æŒ‡æ¨™", desc: "KP è¶Šé«˜ï¼Œç¯„åœè¶Šå¤§ã€‚", info: "ğŸ’¬ **KP Index (0-9)ï¼š**\n- **KP 0-2:** åªæœ‰ç›¸æ©Ÿæ‹å¾—åˆ°ï¼Œè‚‰çœ¼çœ‹åƒç°è‰²çš„é›²ã€‚\n- **KP 3-4:** è‚‰çœ¼å¯è¦‹æ·¡æ·¡çš„ç¶ è‰²å…‰å¸¶åœ¨èˆå‹•ã€‚\n- **KP 5+:** æ¥µå…‰å¤§çˆ†ç™¼ (Storm Level)ï¼Œå¯èƒ½æ¼«å¤©é£›èˆï¼Œç”šè‡³å‡ºç¾ç´«è‰²/ç´…è‰²ï¼Œå°±åœ¨é ­é ‚ä¸Šè·³èˆï¼" },
                { name: "æ‹æ”åƒæ•¸ (æ‰‹æ©Ÿ)", tag: "æ”å½±", desc: "iPhone/Android è¨­å®šã€‚", info: "ğŸ“± **iPhone:**\né–‹å•Ÿã€Œå¤œé–“æ¨¡å¼ã€ï¼Œæ‰‹æŒç›¡é‡ç©©ä½ï¼ˆ3-10ç§’ï¼‰ï¼Œæœ€å¥½ç”¨è…³æ¶ï¼ˆå¯é–‹åˆ°30ç§’ï¼‰ã€‚\n\nğŸ“± **Android Pro Mode:**\n- ISO: 1600 - 3200\n- å¿«é–€ (Shutter): 5s - 15s\n- å°ç„¦: ç„¡é™é " },
                { name: "æ‹æ”åƒæ•¸ (ç›¸æ©Ÿ)", tag: "æ”å½±", desc: "å¤§å…‰åœˆæ˜¯é—œéµã€‚", info: "ğŸ“· **è¨­å®šå»ºè­°ï¼š**\n- æ¨¡å¼: M (æ‰‹å‹•)\n- å…‰åœˆ: æœ€å¤§ (f/2.8 æˆ–æ›´å¤§)\n- ISO: 1600 - 6400 (ä¾é›œè¨Šæ¥å—åº¦)\n- å¿«é–€: 2s - 8s (å¤ªé•·æ¥µå…‰æœƒç³Šæ‰è®Šä¸€ç‰‡ç¶ )\n- å°ç„¦: æ‰‹å‹•å°ç„¦åˆ°ç„¡é™é  (æ‰¾é è™•ç‡ˆå…‰æˆ–æ˜Ÿæ˜Ÿ)" }
            ]},
            { category: "ğŸ’¡ å¯¦ç”¨è²¼å£«", content: [
                { name: "è³¼ç‰©å…ç¨…ï¼", tag: "çœéŒ¢", desc: "Anchorage & Fairbanks ç„¡å·ç¨…ã€‚", info: "ğŸ’¬ **ç›¡æƒ…è²·ï¼š**\né˜¿æ‹‰æ–¯åŠ æ²’æœ‰ã€Œå·éŠ·å”®ç¨…ã€(State Sales Tax)ã€‚Anchorage å’Œ Fairbanks å¸‚å€é€šå¸¸ä¹Ÿæ²’æœ‰åœ°æ–¹ç¨…ï¼Œæ‰€ä»¥æ¨™åƒ¹å¤šå°‘å°±ä»˜å¤šå°‘ï¼éå¸¸é©åˆè²·å§‹ç¥–é³¥ã€Patagonia ç­‰æˆ¶å¤–è£å‚™æˆ– iPhoneã€‚" },
                { name: "å°è²»æ–‡åŒ–", tag: "ç¦®å„€", desc: "ç¾åœ‹æ¨™æº– 15-20%ã€‚", info: "ğŸ’¬ **é¤å»³ï¼š**\nåˆé¤ 15-18%ï¼Œæ™šé¤ 18-20% æ˜¯æ¨™æº–ã€‚å¦‚æœæ˜¯ 6 äººä»¥ä¸Šå¤§æ¡Œï¼Œé¤å»³å¯èƒ½æœƒè‡ªå‹•åŠ æ”¶ 18% Gratuityã€‚\n\nğŸ’¬ **å°éŠ/å¸æ©Ÿï¼š**\næ¥µå…‰åœ˜å°éŠå¦‚æœä¸åšï¼Œé€šå¸¸çµ¦ $10-20/äººï¼›æ¥é§è»Šå¸æ©Ÿå¹«å¿™æ¬è¡Œæçµ¦ $1-2/ç®±ã€‚" },
                { name: "é£²ç”¨æ°´", tag: "ç”Ÿæ´»", desc: "æ°´é¾é ­æ°´å¯ä»¥å–ã€‚", info: "ğŸ’¬ **æ°´è³ªï¼š**\né˜¿æ‹‰æ–¯åŠ çš„è‡ªä¾†æ°´æ°´è³ªé€šå¸¸å¾ˆå¥½ï¼ˆä¾†è‡ªå†°å·èæ°´ï¼‰ï¼Œå¯ä»¥ç›´æ¥ç”Ÿé£²ã€‚å¦‚æœä¸æ”¾å¿ƒï¼Œé£¯åº—é€šå¸¸æœ‰æ¿¾æ°´ç«™ã€‚å‡ºé–€è¨˜å¾—å¸¶ä¿æº«ç“¶è£ç†±æ°´ï¼" },
                { name: "ç·Šæ€¥é›»è©±", tag: "å®‰å…¨", desc: "é‡é›£è«‹æ’¥ 911ã€‚", info: "ğŸ’¬ **æ±‚æ•‘ï¼š**\né‡åˆ°è»Šç¦ã€ç«ç½ã€æ€¥ç—…æˆ–å¨è„…ç”Ÿå‘½çš„æƒ…æ³ï¼Œç›´æ¥æ’¥æ‰“ 911ã€‚å¦‚æœåœ¨æ²’æœ‰è¨Šè™Ÿçš„åœ°æ–¹ï¼Œå˜—è©¦ç™¼é€ç°¡è¨Šè‡³ 911 (Text-to-911) åœ¨æŸäº›åœ°å€å¯èƒ½æœ‰æ•ˆã€‚" }
            ]}
        ];

        // --- PREP LIST DATA ---
        const prepItems = [
            "ğŸ—ºï¸ è¼‰å¥½é›¢ç·šåœ°åœ– (Anchorage/Fairbanks)",
            "ğŸŒ¤ï¸ ä¸‹è¼‰æ¥µå…‰/å¤©æ°£ APP",
            "ğŸ”¥ æš–æš–åŒ… (å¤§é‡ï¼Œè²¼å¼èˆ‡æ‰‹æ¡å¼)",
            "ğŸ“· é‹å‹•ç›¸æ©Ÿ/è…³æ¶ (æ‹æ¥µå…‰å¿…å‚™)",
            "ğŸ•¶ï¸ å¤ªé™½çœ¼é¡ (é›ªåœ°åå…‰å¼·)",
            "ğŸ”Œ è»Šå……/è¡Œå‹•é›»æº (ä½æº«è€—é›»å¿«)",
            "ğŸ§´ ä¿æ¿•ä¹³æ¶²/è­·å”‡è† (æ¥µä¹¾)",
            "ğŸ§¤ é›™å±¤æ‰‹å¥— & æ¯›å¸½",
            "ğŸ§¦ ç¾Šæ¯›è¥ª (å»ºè­° Smartwool ç­‰ç´š)",
            "ğŸ†” é§•ç…§/ä¿¡ç”¨å¡/ä¿éšªå¡"
        ];

        // --- LOGIC ---
        function renderDays() {
            const scroller = document.querySelector('.day-scroller');
            scroller.innerHTML = '';
            daysData.forEach((day, index) => {
                const chip = document.createElement('div');
                chip.className = `day-chip ${index === 0 ? 'active' : ''} animate-item`;
                chip.onclick = () => switchDay(index);
                chip.innerHTML = `<span class="d-date">${day.date}</span><span class="d-week">${day.week}</span>`;
                scroller.appendChild(chip);
            });
            switchDay(0);
            
            // Start Countdown
            updateCountdown();
            setInterval(updateCountdown, 60000);
            
            // Render Prep List
            renderPrepList();
        }

        function updateCountdown() {
            const tripStart = new Date('2025-12-26T00:00:00-09:00'); // Alaska Time
            const now = new Date();
            const diff = tripStart - now;
            const banner = document.getElementById('countdown-banner');
            if(diff > 0) {
                const days = Math.floor(diff / (1000 * 60 * 60 * 24));
                const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                banner.innerText = `è·é›¢é˜¿æ‹‰æ–¯åŠ é‚„æœ‰ ${days}å¤© ${hours}å°æ™‚ âœˆï¸`;
                banner.style.opacity = '1'; 
            } else if (diff > -7 * 24 * 60 * 60 * 1000) {
                banner.innerText = "æ—…ç¨‹é€²è¡Œä¸­ â„ï¸";
                banner.style.opacity = '1';
            } else {
                banner.style.display = 'none';
            }
        }

        function switchDay(index) {
            const data = daysData[index];
            document.getElementById('header-title').innerText = data.title;
            document.getElementById('header-subtitle').innerText = `${data.date} ${data.week}`;
            document.getElementById('header-subtitle').style.color = data.color;
            
            // Update global current location for weather click
            currentWeatherLoc = data.weatherLoc;
            
            document.querySelectorAll('.day-chip').forEach((chip, idx) => {
                if (idx === index) { chip.classList.add('active'); chip.style.backgroundColor = data.color; } 
                else { chip.classList.remove('active'); chip.style.backgroundColor = 'rgba(255,255,255,0.9)'; }
            });

            document.documentElement.style.setProperty('--theme-color', data.color);
            document.getElementById('bg-itinerary').style.backgroundImage = `url('${data.bgImg}')`;

            const container = document.getElementById('day-content');
            
            // Scroll to top of itinerary content
            const itContent = document.getElementById('tab-itinerary');
            if(itContent) itContent.scrollTop = 0;

            let weatherGradient = `linear-gradient(135deg, ${data.color}dd 0%, ${data.color} 100%)`;
            
            let html = `
                <a href="${data.mapUrl}" target="_blank" class="map-btn-compact animate-item">
                    <i data-lucide="map-pin"></i> æŸ¥çœ‹ä»Šæ—¥è·¯ç·šåœ°åœ–
                </a>
               
                <!-- Weather Chart -->
                <div id="day-weather-card" class="weather-detail-card animate-item" style="background: ${weatherGradient}" onclick="window.open('https://www.google.com/search?q=weather+${data.weatherLoc}','_blank')">
                    <div class="wd-header">
                        <span class="wd-title"><i data-lucide="cloud-snow"></i> 9 AM - 9 PM</span>
                        <span class="wd-info" id="w-header-info">æœ€é«˜: --Â° | æœ€ä½: --Â°</span>
                    </div>
                    <div class="wd-title" style="font-size:11px; margin-top:-5px; margin-bottom:5px; opacity:0.8; padding-left:5px;">
                        ${data.weatherLoc} æ°£æº«é æ¸¬ (é»æ“Šè©³æƒ…)
                    </div>
                    <div class="wd-chart-container">
                        <div id="chart-icons-layer"></div>
                        <svg class="wd-chart-svg" id="w-chart" style="width:100%; height:100%;"></svg>
                    </div>
                </div>

                <!-- Aurora Chart -->
                <div id="day-aurora-card" class="aurora-detail-card animate-item">
                    <div class="wd-header">
                        <span class="wd-title"><i data-lucide="sparkles"></i> æ¥µå…‰é å ± (21:00-03:00)</span>
                        <span class="wd-info" style="font-size:10px;">${data.weatherLoc.includes('Fairbanks') ? 'é«˜ç·¯åº¦å€' : 'ä¸­ç·¯åº¦å€'}</span>
                    </div>
                    <div class="wd-title" style="font-size:11px; margin-top:-5px; margin-bottom:5px; opacity:0.9; padding-left:5px;">
                        è§€æ¸¬æŒ‡å—: ç¶ æŸ±é«˜ + ç™½ç·šä½ = æœ€ä½³æ™‚æ©Ÿ
                    </div>
                    
                    <!-- Chart Area -->
                    <div class="wd-chart-container" style="height:120px;">
                        <svg class="wd-chart-svg" id="a-chart" style="width:100%; height:100%;"></svg>
                    </div>

                    <!-- Legend -->
                    <div style="display:flex; justify-content:center; gap:15px; margin-top:10px; font-size:11px; opacity:0.9;">
                        <div style="display:flex; align-items:center; gap:5px;">
                            <div style="width:12px; height:12px; background:rgba(255,255,255,0.8); border-radius:2px;"></div>
                            <span>KPæ¥µå…‰å¼·åº¦ (é«˜=å¼·)</span>
                        </div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <div style="width:12px; height:2px; background:white; border-top:2px dashed white;"></div>
                            <span>é›²å±¤è¦†è“‹ (ä½=æ¸…æ¾ˆ)</span>
                        </div>
                    </div>
                </div>
            `;

            html += `<div class="card animate-item">`; 
            data.content.forEach((item) => {
                const safeName = item.name.replace(/'/g, "\\'").replace(/"/g, "&quot;"); 
                const safeDesc = item.desc.replace(/'/g, "\\'").replace(/"/g, "&quot;"); 
                const safeInfo = item.info.replace(/'/g, "\\'").replace(/"/g, "&quot;").replace(/\n/g, "\\n");
                html += `
                    <div class="place-item" onclick="openModal('${safeName}', '${safeDesc}', '${safeInfo}')">
                        <div class="place-header"><span class="place-name" style="color:${data.color}">${item.name}</span><span class="place-tag">${item.tag}</span></div>
                        <p class="place-desc">${item.desc}</p>
                    </div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
            lucide.createIcons();
            
            // Fetch Weather
            const today = new Date().toISOString().split('T')[0];
            fetchDetailedWeather(data.coords, today); 
            fetchCurrentWeather(data.coords, data.weatherLoc);
        }

        // Function to open weather from header
        function openCurrentWeather() {
            if(currentWeatherLoc) {
                window.open(`https://www.google.com/search?q=weather+${currentWeatherLoc}`, '_blank');
            }
        }

        // ... (Render Guide Functions - same as before) ...
        function renderGuideScroller() {
            const scroller = document.getElementById('guide-scroller');
            scroller.innerHTML = '';
            guideData.forEach((cat, index) => {
                const chip = document.createElement('div');
                chip.className = `guide-chip ${index === 0 ? 'active' : ''} animate-item`;
                chip.innerText = cat.category;
                chip.onclick = () => switchGuideCategory(index);
                scroller.appendChild(chip);
            });
            switchGuideCategory(0);
        }

        function switchGuideCategory(index) {
            const data = guideData[index];
            const chips = document.querySelectorAll('.guide-chip');
            chips.forEach((chip, idx) => {
                if (idx === index) chip.classList.add('active');
                else chip.classList.remove('active');
            });

            const container = document.getElementById('guide-content');
            
            // Handle "Prep" special case
            if (data.id === 'prep') {
                let html = `
                    <div class="card animate-item" style="margin-top:10px;">
                        <div class="packing-header">
                            <div class="place-header"><span class="place-name">ğŸ’ æº–å‚™ç‰©å“</span><span class="place-tag highlight" id="pack-count">0/0</span></div>
                            <div class="progress-container"><div class="progress-bar" id="pack-progress"></div></div>
                            <div class="progress-text"><span>å®Œæˆåº¦</span><span id="pack-percent">0%</span></div>
                        </div>
                        <div id="packing-list"></div>
                    </div>
                    <button class="btn-action animate-item" style="width:100%; justify-content:center; margin-top:20px; background:rgba(255,255,255,0.5);" onclick="resetPackingList(this)">é‡ç½®æ¸…å–®</button>
                `;
                container.innerHTML = html;
                renderPrepList(); 
                return;
            }

            // Normal Guide Card Rendering
            let html = `<div class="card animate-item" style="margin-top:10px;">`;
            data.content.forEach(item => {
                const safeName = item.name.replace(/'/g, "\\'").replace(/"/g, "&quot;"); 
                const safeDesc = item.desc.replace(/'/g, "\\'").replace(/"/g, "&quot;"); 
                const safeInfo = item.info.replace(/'/g, "\\'").replace(/"/g, "&quot;").replace(/\n/g, "\\n");
                html += `
                    <div class="place-item" onclick="openModal('${safeName}', '${safeDesc}', '${safeInfo}')">
                        <div class="place-header"><span class="place-name">${item.name}</span><span class="place-tag secondary">${item.tag}</span></div>
                        <p class="place-desc">${item.desc}</p>
                    </div>`;
            });
            html += `</div>`;
            container.innerHTML = html;
        }

        // --- PREP LIST LOGIC (Same as before) ---
        function renderPrepList() {
            const container = document.getElementById('packing-list');
            if(!container) return;
            container.innerHTML = '';
            
            const savedState = JSON.parse(localStorage.getItem('alaskaTripPrep') || '{}');
            let checkedCount = 0;

            prepItems.forEach((item, index) => {
                const isChecked = savedState[index] || false;
                if(isChecked) checkedCount++;
                
                const div = document.createElement('div');
                div.className = `checkbox-item ${isChecked ? 'checked' : ''}`;
                div.onclick = () => toggleCheck(index);
                div.innerHTML = `
                    <div class="custom-checkbox"><i data-lucide="check" class="check-icon" size="16"></i></div>
                    <span class="place-name" style="font-size:15px; font-weight:500;">${item}</span>
                `;
                container.appendChild(div);
            });
            
            updateProgress(checkedCount, prepItems.length);
            lucide.createIcons();
        }

        function toggleCheck(index) {
            const savedState = JSON.parse(localStorage.getItem('alaskaTripPrep') || '{}');
            savedState[index] = !savedState[index];
            localStorage.setItem('alaskaTripPrep', JSON.stringify(savedState));
            renderPrepList();
        }

        function updateProgress(checked, total) {
            const percent = Math.round((checked / total) * 100);
            const bar = document.getElementById('pack-progress');
            const pText = document.getElementById('pack-percent');
            const count = document.getElementById('pack-count');
            
            if(bar) bar.style.width = `${percent}%`;
            if(pText) pText.innerText = `${percent}%`;
            if(count) count.innerText = `${checked}/${total}`;
        }

        function resetPackingList(btnElement) {
            if (btnElement.innerText === "é‡ç½®æ¸…å–®") {
                btnElement.innerText = "ç¢ºå®šè¦é‡ç½®ï¼Ÿ(é»æ“Šç¢ºèª)";
                btnElement.style.backgroundColor = "#ffeba1"; 
                btnElement.style.color = "#d35400";
                
                setTimeout(() => {
                    if (btnElement.innerText !== "é‡ç½®æ¸…å–®" && btnElement.innerText !== "å·²å®Œæˆé‡ç½®") {
                       btnElement.innerText = "é‡ç½®æ¸…å–®";
                       btnElement.style.backgroundColor = "rgba(255,255,255,0.5)";
                       btnElement.style.color = "var(--theme-color)";
                    }
                }, 3000);
                return;
            }

            localStorage.removeItem('alaskaTripPrep');
            renderPrepList();
            
            btnElement.innerText = "å·²å®Œæˆé‡ç½®";
            btnElement.style.backgroundColor = "#d4edda";
            btnElement.style.color = "#155724";
            
            setTimeout(() => {
                btnElement.innerText = "é‡ç½®æ¸…å–®";
                btnElement.style.backgroundColor = "rgba(255,255,255,0.5)";
                btnElement.style.color = "var(--theme-color)";
            }, 1500);
        }

        function switchTab(tabId, el) {
            document.querySelectorAll('.content-area').forEach(div => div.classList.remove('active'));
            document.querySelectorAll('.tab-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.bg-image').forEach(bg => bg.classList.remove('active'));

            // Handle Weather Widget Visibility
            const weatherWidget = document.querySelector('.weather-widget');
            if (tabId === 'itinerary') {
                if(weatherWidget) {
                    weatherWidget.style.visibility = 'visible';
                    weatherWidget.style.opacity = '1';
                }
            } else {
                if(weatherWidget) {
                    weatherWidget.style.opacity = '0';
                    setTimeout(() => weatherWidget.style.visibility = 'hidden', 300);
                }
            }

            // Handle Themes
            if (tabId === 'itinerary') {
                document.getElementById('bg-itinerary').classList.add('active');
                const activeIndex = Array.from(document.querySelectorAll('.day-chip')).findIndex(c => c.classList.contains('active'));
                switchDay(activeIndex !== -1 ? activeIndex : 0);
            } else if (tabId === 'flights') {
                document.getElementById('bg-flights').classList.add('active');
                document.documentElement.style.setProperty('--theme-color', '#2980b9'); 
                document.getElementById('header-title').innerText = "äº¤é€šè³‡è¨Š";
                document.getElementById('header-subtitle').innerText = "Flights & Car";
                document.getElementById('header-subtitle').style.color = '#2980b9';
            } else if (tabId === 'hotels') {
                document.getElementById('bg-hotels').classList.add('active');
                document.documentElement.style.setProperty('--theme-color', '#8e44ad'); 
                document.getElementById('header-title').innerText = "ä½å®¿å®‰æ’";
                document.getElementById('header-subtitle').innerText = "Hotels";
                document.getElementById('header-subtitle').style.color = '#8e44ad';
            } else if (tabId === 'guide') {
                document.getElementById('bg-guide').classList.add('active');
                document.documentElement.style.setProperty('--theme-color', '#27ae60'); 
                document.getElementById('header-title').innerText = "æ—…éŠæŒ‡å—";
                document.getElementById('header-subtitle').innerText = "Explore";
                document.getElementById('header-subtitle').style.color = '#27ae60';
                if(document.getElementById('guide-content').innerHTML === "") renderGuideScroller();
            }

            document.getElementById('tab-' + tabId).classList.add('active');
            el.classList.add('active');
        }

        function openModal(title, subtitle, desc) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-desc').innerHTML = `<strong>${subtitle}</strong><br><br>${desc.replace(/\n/g, '<br>')}`;
            document.getElementById('detail-modal').classList.add('open');
        }
        function closeModal() { document.getElementById('detail-modal').classList.remove('open'); }

        async function fetchCurrentWeather(coords, locName) {
            const [lat, long] = coords.split(',');
            document.getElementById('current-loc').innerText = locName;
            try {
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${long}&current=temperature_2m&temperature_unit=celsius`;
                const res = await fetch(url); const json = await res.json();
                document.getElementById('current-temp').innerText = `${Math.round(json.current.temperature_2m)}Â°C`;
            } catch (e) { console.error(e); }
        }
        
        function getIconFromCode(code) {
            if (code === 0) return 'sun';
            if (code <= 3) return 'cloud-sun';
            if (code <= 48) return 'cloud-fog';
            if (code <= 67) return 'cloud-rain';
            if (code <= 77) return 'snowflake';
            if (code <= 82) return 'cloud-rain';
            if (code <= 86) return 'snowflake';
            return 'cloud-lightning'; // 95+
        }

        // 2. Detailed Weather & Cloud Cover Fetch
        async function fetchDetailedWeather(coords, dateStr) {
            const [lat, long] = coords.split(',');
            
            // Calculate tomorrow date for 2-day range (to cover night crossover)
            const d = new Date(dateStr);
            d.setDate(d.getDate() + 1);
            const tomorrowStr = d.toISOString().split('T')[0];

            try {
                // Fetch 2 days of data: today and tomorrow
                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${long}&daily=temperature_2m_max,temperature_2m_min,sunset&hourly=temperature_2m,weathercode,cloud_cover&start_date=${dateStr}&end_date=${tomorrowStr}&temperature_unit=celsius&timezone=auto`;
                const res = await fetch(url); 
                const json = await res.json();

                if(json.daily && json.daily.temperature_2m_max) {
                    const max = Math.round(json.daily.temperature_2m_max[0]);
                    const min = Math.round(json.daily.temperature_2m_min[0]);
                    let sunsetTime = "--:--";
                    if(json.daily.sunset && json.daily.sunset[0]) {
                        const dateObj = new Date(json.daily.sunset[0]);
                        let hours = dateObj.getHours();
                        const minutes = dateObj.getMinutes().toString().padStart(2, '0');
                        const ampm = hours >= 12 ? 'ä¸‹åˆ' : 'ä¸Šåˆ';
                        hours = hours % 12;
                        hours = hours ? hours : 12; 
                        sunsetTime = `${ampm} ${hours}:${minutes}`;
                    }
                    const hlElement = document.getElementById('w-header-info');
                    if(hlElement) hlElement.innerText = `æœ€é«˜:${max}Â° æœ€ä½:${min}Â° | æ—¥è½ ${sunsetTime}`;
                }

                if(json.hourly && json.hourly.temperature_2m) {
                    // Weather Chart Data (Daytime 9AM - 9PM today)
                    // Indices 9 to 21 (inclusive is 13 points, let's stick to current logic)
                    const hoursTemp = json.hourly.temperature_2m.slice(9, 22); 
                    const hoursCode = json.hourly.weathercode.slice(9, 22);
                    currentHourlyTemps = hoursTemp;
                    currentHourlyCodes = hoursCode; 
                    drawChart(hoursTemp, hoursCode);

                    // Aurora Chart Data (Nighttime 21:00 today - 03:00 tomorrow)
                    // 21:00 is index 21. 03:00 tomorrow is index 27 (24+3).
                    // Slice from 21 to 27 (6 hours: 21, 22, 23, 00, 01, 02)
                    // Ensure we have enough data (OpenMeteo gives full days)
                    if (json.hourly.cloud_cover.length > 27) {
                        const nightClouds = json.hourly.cloud_cover.slice(21, 27);
                        currentAuroraCloud = nightClouds;
                        
                        // Generate Mock KP based on Lat
                        const latNum = parseFloat(lat);
                        const isHighLat = latNum > 63; // Fairbanks is 64, Anchorage 61
                        drawAuroraChart(nightClouds, isHighLat);
                    }
                }
            } catch (e) { 
                console.error("Weather error", e); 
                const card = document.getElementById('day-weather-card');
                if(card) card.style.display = 'none'; 
            }
        }

        // Draw Weather Chart (Line)
        function drawChart(temps, codes) {
            if (!temps || temps.length === 0) return;
            const container = document.querySelector('.wd-chart-container');
            const svg = document.getElementById('w-chart');
            const iconsLayer = document.getElementById('chart-icons-layer');
            if(!svg || !iconsLayer) return;

            // Dynamic Width Calculation
            const w = container.getBoundingClientRect().width || 300; 
            const h = 150; 
            
            svg.innerHTML = ''; iconsLayer.innerHTML = ''; 
            svg.setAttribute('viewBox', `0 0 ${w} ${h}`);

            const padding = 20; 
            const minTemp = Math.min(...temps) - 1;
            const maxTemp = Math.max(...temps) + 1;
            const range = maxTemp - minTemp;
            const stepX = (w - padding * 2) / (temps.length - 1);
            
            // Adjusted margins
            const chartTop = 40; const chartBottom = h - 30; const graphHeight = chartBottom - chartTop - 20; 

            let points = ""; let circles = ""; let labels = ""; let timeLabels = "";
            let areaPath = `M ${padding},${chartBottom} `;

            temps.forEach((t, i) => {
                const x = padding + i * stepX;
                const y = chartBottom - ((t - minTemp) / range) * graphHeight;
                points += `${x},${y} `; areaPath += `L ${x},${y} `;
                
                // Larger circles and text for better visibility
                circles += `<circle cx="${x}" cy="${y}" r="4" class="chart-dot" />`;
                labels += `<text x="${x}" y="${y - 15}" class="chart-text" style="font-size:14px;">${Math.round(t)}Â°</text>`;
                
                let timeVal = (9 + i);
                let displayTime = timeVal > 12 ? (timeVal - 12) + "æ™‚" : (timeVal === 12 ? "ä¸­åˆ" : timeVal + "æ™‚");
                timeLabels += `<text x="${x}" y="${h - 5}" class="chart-label" style="font-size:12px;">${displayTime}</text>`;

                if(codes && codes[i] !== undefined) {
                    const iconName = getIconFromCode(codes[i]);
                    const iconDiv = document.createElement('div');
                    iconDiv.className = 'chart-icon-wrapper';
                    
                    // Manually map SVG coordinate 'x' to percentage for HTML overlay
                    const percentX = (x / w) * 100;
                    
                    iconDiv.style.left = `${percentX}%`; 
                    iconDiv.style.top = '10px'; 
                    iconDiv.innerHTML = `<i data-lucide="${iconName}" style="width:20px; height:20px;"></i>`;
                    iconsLayer.appendChild(iconDiv);
                }
            });
            areaPath += `L ${padding + (temps.length - 1) * stepX},${chartBottom} Z`;
            svg.innerHTML = `<path d="${areaPath}" class="chart-area" /><polyline points="${points}" class="chart-line" />${circles}${labels}${timeLabels}`;
            
            // Re-run lucide for new icons
            lucide.createIcons();
        }

        // NEW: Draw Aurora Chart (Bar + Line)
        function drawAuroraChart(clouds, isHighLat) {
            const svg = document.getElementById('a-chart');
            if(!svg) return;
            
            // Dynamic Width Calculation
            const container = svg.parentElement;
            const w = container.getBoundingClientRect().width || 300; 
            const h = 120;
            
            svg.innerHTML = '';
            svg.setAttribute('viewBox', `0 0 ${w} ${h}`);

            // Mock KP Data (6 data points: 21, 22, 23, 00, 01, 02)
            const kpData = [];
            for(let i=0; i<6; i++) {
                const base = isHighLat ? 4 : 2;
                const varVal = Math.floor(Math.random() * 3); // 0-2
                kpData.push(base + varVal);
            }

            const stepX = w / 6;
            const barWidth = stepX * 0.5; // Slightly narrower bars
            const maxKP = 9;
            
            // Draw Bars (KP)
            let bars = "";
            let kpLabels = "";
            kpData.forEach((kp, i) => {
                const height = (kp / maxKP) * (h - 50);
                const x = i * stepX + (stepX - barWidth)/2;
                const y = h - 30 - height;
                // Green color intensity based on KP
                const opacity = 0.4 + (kp/10);
                bars += `<rect x="${x}" y="${y}" width="${barWidth}" height="${height}" fill="rgba(255,255,255,${opacity})" rx="4" />`;
                kpLabels += `<text x="${x + barWidth/2}" y="${y - 8}" font-size="12" fill="white" text-anchor="middle" font-weight="bold">KP${kp}</text>`;
            });

            // Draw Cloud Line
            let cloudPath = "";
            let cloudDots = "";
            if (clouds && clouds.length > 0) {
                // Normalize cloud 0-100 to y
                clouds.forEach((c, i) => {
                    if (i >= 6) return;
                    const x = i * stepX + stepX/2;
                    const y = h - 30 - (c / 100) * (h - 60); // slightly scale down
                    if (i===0) cloudPath += `M ${x},${y} `;
                    else cloudPath += `L ${x},${y} `;
                    cloudDots += `<circle cx="${x}" cy="${y}" r="4" fill="white" stroke="#2E86C1" stroke-width="2" />`;
                });
            }

            // Time Labels
            let timeLabels = "";
            const times = ["21:00", "22:00", "23:00", "00:00", "01:00", "02:00"];
            times.forEach((t, i) => {
                const x = i * stepX + stepX/2;
                timeLabels += `<text x="${x}" y="${h - 5}" font-size="12" fill="rgba(255,255,255,0.9)" text-anchor="middle" font-weight="500">${t}</text>`;
            });

            svg.innerHTML = `
                ${bars}
                ${kpLabels}
                <path d="${cloudPath}" fill="none" stroke="white" stroke-width="3" stroke-dasharray="6 4" />
                ${cloudDots}
                ${timeLabels}
            `;
        }

        window.addEventListener('resize', () => { 
            // Redraw both charts on resize
            if(currentHourlyTemps.length > 0) drawChart(currentHourlyTemps, currentHourlyCodes);
            if(currentAuroraCloud.length > 0) {
                 // We need lat again to determine high lat, but for simplicity re-use logic
                 const isFairbanks = document.getElementById('header-weather-widget').innerText.includes('Fairbanks');
                 drawAuroraChart(currentAuroraCloud, isFairbanks); 
            }
        });
        window.onload = renderDays;
    </script>
</body>
</html>
